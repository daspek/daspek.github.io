<html>
  <head>
      <title>welcome to twoDrive</title>
      <link rel="stylesheet" type="text/css" href="style.css">
      <script type="text/javascript">
        var APP_CLIENT_ID = "000000004812DC2E";
        var REDIRECT_URL = "https://daspek.github.io/2drv/callback.html";
      </script>
      <script type="text/javascript" src="https://code.jquery.com/jquery-1.4.2.min.js"></script>
      <script src="https://js.live.net/v5.0/wl.js"></script>
  </head>
  <body>
        <div id="signin"></div>
        <label id="info"></label>
        <div id="od-items"></div>
        <script>
            WL.Event.subscribe("auth.login", onLogin);
            WL.init({
                client_id: APP_CLIENT_ID,
                redirect_uri: REDIRECT_URL,
                scope: ["wl.signin","wl.skydrive","wl.skydrive_update","wl.contacts_skydrive"],
                response_type: "token"
            });
            WL.ui({
                name: "signin",
                element: "signin"
            });
            function onLogin (session) {
                if (!session.error) {
                  (function($){

                    var path ="";
                    var hashIndex = document.URL.indexOf('#');
                    if (hashIndex > 0)
                    {
                      path = document.URL.substr(hashIndex + 1);
                    }

                    var token = "UNK";
                    var cookie = document.cookie;
                    var vars = cookie.split('&');
                    for (var i = 0; i < vars.length; i++) {
                        var pair = vars[i].split('=');
                        if (pair[0] == "access_token") {
                            token = pair[1];
                            break;
                        }
                    }
                    //$('<p></p>').text('loading...' + cookie).appendTo('#od-items');


            var odurl = "https://newapi.users.storage.live.com/me/files" + path + "?$expand=children%26access_token=" + token;
            var proxurl = "https://jsonp.nodejitsu.com/?url=" + odurl;
              $('<p></p>').text('loading...').appendTo('#od-items');
             $.ajax({
                      url: proxurl,
                      dataType: 'json',
                      success: function(data) {
                          if (data) {
                              $('#od-items').empty();
                              if (data) {
                                  $('<p></p>').text(data.parentInfo.path + "/" + data.name).appendTo('#od-items');
                                  if (data.children)
                                  {
                                    $.each(data.children, function(i,item) {
                                        var tile = $("<div>").
                                          attr("href", "#" + path + "/" + item.name).
                                          click(function(){window.location=$(this).attr('href')}).
                                          addClass("item").
                                          appendTo("#od-items");

                                        if (item.folder)
                                        {
                                          tile.addClass("folder");
                                        }

                                        $("<p>"+item.name+"</p>").appendTo(tile);


                                        //$("<img/>").
                                        //  attr("src", item.file.contentUrl).
                                        //  appendTo("#od-items").
                                        //  wrap("<div class='file'></div>").
                                        //  wrap("<a href='" + item.file.contentUrl + "?width=200&height=150'></a>");
                                    });
                                  }
                              } else {
                                  $('<p>error.</p>').appendTo('#od-items');
                              }
                          } else {
                              $('#od-items').empty();
                              alert(data);
                          }
                      }
                  });



                  })(jQuery);
                }
                else {
                    document.getElementById("info").innerText =
                        "Error signing in: " + session.error_description;
                }
            }
        </script>
  </body>
</html>
